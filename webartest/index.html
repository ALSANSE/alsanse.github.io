<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- [라이브러리 로드] -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <!-- [오프라인용] -->
  <!-- <script src="./engines/aframe.min.js"></script> -->
  <!-- <script src="./engines/mindar-image-aframe.prod.js"></script> -->
  <!-- <script src="./engines/aframe-extras.min.js"></script> -->

  <script>
    // [장독대 애니메이션 및 사운드 제어 컴포넌트]
    AFRAME.registerComponent('play-jangdok-anim', {
      init: function () {
        const el = this.el;

        // 1. 모델이 로딩되면 애니메이션 이름이 뭔지 콘솔에 다 찍어본다 (디버깅용)
        el.addEventListener('model-loaded', function (evt) {
          const model = el.getObject3D('mesh');
          if (model && model.animations && model.animations.length > 0) {
            console.log("=== 모델 애니메이션 목록 ===");
            model.animations.forEach((anim, index) => {
              console.log(`${index}: ${anim.name}`);
            });
            console.log("==========================");
          } else {
            console.warn("이 모델에는 애니메이션이 없습니다.");
          }
        });

        // 2. 클릭(터치) 이벤트 리스너
        el.addEventListener('click', function (evt) {
          console.log("장독대 터치됨! 애니메이션 및 사운드 시작.");

          // [사운드 재생 로직 개선]
          if (el.components.sound) {
            // [추가] 오디오 컨텍스트가 잠겨있으면 풀어준다 (브라우저 정책 대응)
            // 사용자가 클릭한 시점이라서 풀릴 확률이 높음
            if (AFRAME.scenes[0].audioListener && AFRAME.scenes[0].audioListener.context.state === 'suspended') {
              AFRAME.scenes[0].audioListener.context.resume();
              console.log("오디오 컨텍스트 강제 실행됨");
            }

            console.log("사운드 재생 명령 보냄");
            el.components.sound.stopSound();
            el.components.sound.playSound();
          } else {
            console.error("사운드 컴포넌트가 없습니다! HTML 태그 확인 바람.");
          }

          // [애니메이션 재생]
          const modelEl = el.querySelector('a-gltf-model');

          if (modelEl) {
            console.log("애니메이션 믹서 부착 중...");

            modelEl.setAttribute('animation-mixer', {
              clip: 'chun_jangdok_coverAction',
              loop: 'once',
              clampWhenFinished: true
            });
          } else {
            console.error("a-gltf-model 태그를 못 찾았습니다.");
          }
        });
      }
    });
  </script>
</head>

<body>
  <!-- 설정 값 유지 -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets/kuSymbol_111.mind; filterMinCF:0.01; filterBeta: 0.1; missTolerance: 5; warmupTolerance: 5;"
    color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="jangdokModel" src="./models/chun_jangdok_opening_v002.glb"></a-asset-item>
      <!-- [사운드 파일] -->
      <!-- 파일명 대소문자, 경로 정확한지 다시 확인해라. (sounds 폴더 안에 jangdok_open.mp3) -->
      <audio id="jangdokSound" src="./sounds/Cuckoo.mp3" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"
      raycaster="far: 10000; objects: .clickable"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">

      <!-- [장독대 그룹] -->
      <!-- [수정됨] positional: false (2D 사운드로 변경), volume: 2 (소리 증폭) -->
      <a-entity play-jangdok-anim sound="src: #jangdokSound; poolSize: 5; positional: false; volume: 2;"
        position="0 -0.25 0" rotation="0 0 0" scale="1 1 1">

        <!-- 실제 모델 -->
        <a-gltf-model class="clickable" src="#jangdokModel">
        </a-gltf-model>

        <!-- 투명 히트 박스 -->
        <a-box class="clickable" material="opacity: 0; transparent: true" position="0 5 0" scale="10 10 10">
        </a-box>
      </a-entity>

    </a-entity>
  </a-scene>
</body>

</html>